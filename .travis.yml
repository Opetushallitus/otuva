sudo: required
language: java
jdk:
  - openjdk11
services:
  - docker
cache:
  directories:
    - $HOME/.m2
env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "n4HCFnEgth2k8guoGrQ3+4xogfxvcLrcL82XgBJ0/gzckMDg6CW1UDjSfiQgjLzdIj44vVlh4Q7SfgFYDXbRRfuccomvYfBLg5M9V+uJuKKSaScpJRrP/tJ3VuOp1CfVCd4ru55Mspwq/76Fw6j8CWjilYivzXmxLrzCoZu2cWWiRvaOw7lZdh/eN9uPzKdK7ULxnzUuH88TB90gWaePECOjiWnk33lBd44OFG51abzwmAQgj4KEQIleKYo8DDabaCZefxmqrxiQlS7ajrcvlIuUE8YyNEQUT8YgOmqBHopPg0vNLaTSQxeVtl5HiV1Y2DRl7EZu+blKo25a4HQLmK6XKIQNE0MTkL2BIlf7VPHM4TtF18m7dWmLyGiWFWwVyoyUwHg6xDl2+fdLt8lRtZpTdwa9SMZuYkgFpYW7fZGnZqgC0H8+A5COOVm1TQ2/94CvIPKp4WczkEx5pZGb7QFepT7YK644RkqZcioRKev+kJlxbhOD7Wi937m0MGHcq3T8kjQE/SwdEVJWnJaUXYgMnEnNnpLjRAOCnLwmLtWsQQpzHJs6iBiKhUx8AI8ieDynBc1p4NLVqJd0d4UIKSreAdfSUZgYh7vZOCMKBwgucp2P60gS7WV4gNVgNnWALX1L9oX1mHgHE74QslGvEJfOQYwLsSohpppQJ4IvjxQ="
    # AWS_SECRET_ACCESS_KEY
    - secure: "AOlKNU0Wx2Osd1kGC9wZUPBCcjShi/i9dDhFeZ/b7tCggK4K1wqg/ZSOjLm/GZNWW1NXnW/NWGJsJahOnwOpaLknnkqSypjuXujKMBJP8fqHdj1d1gXTB8vz0T0n+gWDmZrQVfJELOWwDOHepDF/s/LYintNDHlD7lHtYN+NvqeIeYtuGZTfV2HwkUcqf5mRCLESBri4qnvCHCfdW/btfGyGYa353M44K1eRBjSX2HgTXLKarZPjuywOVprE6GrYp6sldr0/anqJ1Csw1nebVsOHNKZvMHV/dPCme2s0P+bJOQasCs6gYa4sb8vXFIhMuuZdGxJz1PRy1/JrGTDgZMwwuRewEV7WIkG7PHbz2TLzfbctV+3iO1Ab/G4Q9FL5BC2jSBBXD/5+RGz+az6ZMZtjQWfNeqlr9alVhdZexTnUmr9izXo7fArIHAYzcJS4IvLTmNDI3wsajG86bCZ2r7GHg6jQv/Ck3e4Py7/xuHzHf8BPT6asN1h6MhYVx3awe3pGtnWmjQ8HdczwNpGC79x9Qc291NZhagyw1UBGT8uGD1j7FAByPh0YsyNUAdfG/xoo5Ibq1JHDMEVDd8RqU88Uea7nNy1D/xvOg+m+gUA8KoX/mI3DwcPFZu2nFeCCMzLLdjx/WPm0hHU2mFXJJoVFjPxf+p0CgrPL2DBnKrg="

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="service-provider"

script:
  - mvn clean install -B -Dbranch=${TRAVIS_BRANCH} -Drevision=${TRAVIS_COMMIT} -DbuildNumber=${TRAVIS_BUILD_NUMBER}

  - mv target/service-provider-app.war $DOCKER_BUILD_DIR/artifact/service-provider-app.war
  - cp -vr oph-configuration $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-war-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-war.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script: ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true
